{% extends 'base.html' %}

{% block title %}Panel MQTT{% endblock %}

{% block head_scripts %}
<script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-bold">Panel de Sensores MQTT</h2>
  <div>
    <button class="btn btn-dark me-2" onclick="mostrarConsola()">üñ•Ô∏è Consola</button>
    <button class="btn btn-primary" onclick="mostrarGrafico()">üìà Gr√°fico</button>
  </div>
</div>

<div id="consolaContainer" class="mb-4">
  <div id="consola">
    <ul id="mensajes" class="list-unstyled mb-0"></ul>
  </div>
</div>

<div id="graficoContainer" class="card bg-white p-3 d-none">
  <canvas id="graficoTemp"></canvas>
</div>
{% endblock %}

{% block footer_scripts %}
<script>
  const socket = io({ transports: ['websocket'] });
  const ctx = document.getElementById('graficoTemp').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Temperatura (¬∞C)',
        data: [],
        borderColor: 'rgb(13,110,253)',
        backgroundColor: 'rgba(13,110,253,0.2)',
        tension: 0.4
      }]
    },
    options: {
      scales: {
        y: { min: 0, max: 50 }
      },
      plugins: {
        legend: { labels: { color: '#000' } }
      }
    }
  });

  socket.on('connect', () => {
    console.log('Conectado al WebSocket');
  });

  socket.on('nueva_lectura', (data) => {
    const hora = new Date().toLocaleTimeString();
    const li = document.createElement('li');
    li.textContent = `[${hora}] Sensor: ${data.sensor} | Valor: ${data.value}`;
    document.getElementById('mensajes').prepend(li);

    if (data.sensor === "temp") {
      chart.data.labels.push(hora);
      chart.data.datasets[0].data.push(data.value);
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }
  });

  socket.on('disconnect', () => console.warn('Desconectado'));
  socket.on('connect_error', err => console.error('Error:', err.message));

  function mostrarConsola() {
    document.getElementById('consolaContainer').classList.remove('d-none');
    document.getElementById('graficoContainer').classList.add('d-none');
  }

  function mostrarGrafico() {
    document.getElementById('consolaContainer').classList.add('d-none');
    document.getElementById('graficoContainer').classList.remove('d-none');
  }
</script>
{% endblock %}